version: '3.1'

services:
  postgres:
    image: postgres:latest
    restart: on-failure
    ports:
      - "${POSTGRES_INGRESS:-5432}:5432"
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_DB: "codegen_dev"
      POSTGRES_PASSWORD: "postgres"

  data:
    build: 
      context: src/python/dataserv
    ports:
      - "${DATASERV_INGRESS:-8080}:8080"
    volumes:
      - "./data:/data"

  codegen:
    image: elixir:latest
    restart: on-failure
    ports:
      - "${CODEGEN_INGRESS:-4000}:4000"
    volumes:
      - "./src/elixir/codegen:/usr/src/myapp"
    working_dir: /usr/src/myapp
    entrypoint: "./run.sh"
    environment:
      DATABASE_URL: "ecto://postgres:postgres@postgres/codegen_dev"